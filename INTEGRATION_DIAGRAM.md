# ğŸ¨ Visual Integration Architecture

## System Architecture Overview

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                      â”‚
                                    â”‚   Developer using    â”‚
                                    â”‚    Claude Code       â”‚
                                    â”‚                      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ HTTP/WebSocket
                                               â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ claude-code-router   â”‚
â”‚  Smart Routing Layer              â”‚   (Port 3456)        â”‚
â”‚                                   â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ Router Intelligence         â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ â€¢ Token counting            â”‚             â”‚
â”‚  â”‚ â€¢ Context analysis          â”‚             â”‚
â”‚  â”‚ â€¢ Model selection           â”‚             â”‚
â”‚  â”‚ â€¢ Session tracking          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Routing Rules               â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ â€¢ tokens < 10k â†’ fast model â”‚             â”‚
â”‚  â”‚ â€¢ tokens > 60k â†’ long ctx   â”‚             â”‚
â”‚  â”‚ â€¢ thinking â†’ reasoner       â”‚             â”‚
â”‚  â”‚ â€¢ background â†’ cheap model  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â”‚ Routed request
                                                â”‚ (provider,model)
                                                â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    droid2api          â”‚
â”‚  API Normalization Layer          â”‚   (Port 3000)         â”‚
â”‚                                   â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ Authentication              â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ 1. FACTORY_API_KEY          â”‚              â”‚
â”‚  â”‚ 2. REFRESH_TOKEN (auto)     â”‚              â”‚
â”‚  â”‚ 3. ~/.factory/auth.json     â”‚              â”‚
â”‚  â”‚ 4. Client Authorization     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Format Transformation       â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ OpenAI â†”ï¸ Anthropic          â”‚              â”‚
â”‚  â”‚ OpenAI â†”ï¸ Common             â”‚              â”‚
â”‚  â”‚ Streaming transformers      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Reasoning Control           â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ OpenAI: effort parameter    â”‚              â”‚
â”‚  â”‚ Anthropic: budget_tokens    â”‚              â”‚
â”‚  â”‚ Levels: off/low/med/high    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                    â”‚                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                      â”‚ â”‚               â”‚ â”‚                  â”‚
                â”‚  Anthropic API       â”‚ â”‚  OpenAI API   â”‚ â”‚  Other LLMs      â”‚
                â”‚  (Claude models)     â”‚ â”‚  (GPT models) â”‚ â”‚  (DeepSeek, etc) â”‚
                â”‚                      â”‚ â”‚               â”‚ â”‚                  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Request Flow Example

### Scenario: User asks Claude Code to "explain this function"

```
Step 1: Claude Code sends request
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
POST http://localhost:3456/v1/messages
{
  "model": "claude-3-5-sonnet",
  "messages": [{
    "role": "user",
    "content": "explain this function..."
  }],
  "thinking": true
}


Step 2: claude-code-router analyzes
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Token count: 5,234 tokens
â€¢ Has "thinking": true
â€¢ Decision: Route to think model
â€¢ Selected: "droid2api,deepseek-reasoner"


Step 3: claude-code-router forwards to droid2api
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
POST http://localhost:3000/v1/chat/completions
{
  "model": "deepseek-reasoner",
  "messages": [{
    "role": "user",
    "content": "explain this function..."
  }],
  "stream": true
}


Step 4: droid2api transforms request
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Model type: "common" (DeepSeek API)
â€¢ Add reasoning level: "high"
â€¢ Add auth header from FACTORY_API_KEY
â€¢ Transform OpenAI format â†’ DeepSeek format


Step 5: droid2api calls DeepSeek API
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
POST https://api.deepseek.com/chat/completions
Headers:
  Authorization: Bearer sk-xxx
  Content-Type: application/json
Body:
  {
    "model": "deepseek-reasoner",
    "messages": [...],
    "stream": true
  }


Step 6: droid2api streams response back
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ DeepSeek SSE â†’ OpenAI SSE format
â€¢ Add thinking blocks to reasoning field
â€¢ Track token usage
â€¢ Stream to claude-code-router


Step 7: claude-code-router forwards to Claude Code
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ Pass-through streaming
â€¢ Log model used and tokens
â€¢ Update session cache


Step 8: Claude Code displays to user
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Response rendered
ğŸ“Š Model: deepseek-reasoner (via droid2api)
ğŸ’° Cost: $0.005 (vs $0.30 with Claude Opus)
âš¡ Response time: 2.3s
```

## Token Flow & Cost Optimization

```
Context Size Analysis & Routing Decision Tree
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Input: User request arrives at claude-code-router
  â”‚
  â”œâ”€ Count tokens (tiktoken)
  â”‚
  â”œâ”€ Check last session usage
  â”‚
  â””â”€ Analyze request context
      â”‚
      â”œâ”€ Has "thinking"? â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                          â”‚
      â”œâ”€ Is background task? â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
      â”‚                          â”‚    â”‚
      â””â”€ Token count > 60k? â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
                                 â”‚    â”‚    â”‚
                                 â–¼    â–¼    â–¼
                            â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                            â”‚  Routing Matrix   â”‚
                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                 â”‚    â”‚    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚                          â”‚
         â–¼                            â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ thinking=true  â”‚         â”‚ background task  â”‚      â”‚ tokens > 60k     â”‚
â”‚                â”‚         â”‚                  â”‚      â”‚                  â”‚
â”‚ Route to:      â”‚         â”‚ Route to:        â”‚      â”‚ Route to:        â”‚
â”‚ deepseek-      â”‚         â”‚ gpt-5-mini       â”‚      â”‚ gemini-2.5-pro   â”‚
â”‚ reasoner       â”‚         â”‚                  â”‚      â”‚                  â”‚
â”‚                â”‚         â”‚                  â”‚      â”‚                  â”‚
â”‚ Cost: $0.55/1M â”‚         â”‚ Cost: $0.60/1M   â”‚      â”‚ Cost: Free       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Forward to        â”‚
              â”‚   droid2api         â”‚
              â”‚   with model ID     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ droid2api           â”‚
              â”‚ â€¢ Transforms format â”‚
              â”‚ â€¢ Adds reasoning    â”‚
              â”‚ â€¢ Manages auth      â”‚
              â”‚ â€¢ Calls provider    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                   LLM Provider
```

## Configuration Relationship

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ~/.claude.json (Claude Code)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                           â”‚
â”‚   "baseURL": "http://localhost:3456",  â†â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   "apiKey": "dummy-key"                        â”‚            â”‚
â”‚ }                                              â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ Points to
                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ~/.claude-code-router/config.json (Router)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                           â”‚
â”‚   "PORT": 3456,                                             â”‚
â”‚   "Router": {                                               â”‚
â”‚     "default": "droid2api,claude-opus-4",  â†â”€â”€â”€â”€â”           â”‚
â”‚     "background": "droid2api,gpt-5-mini",       â”‚           â”‚
â”‚     "think": "droid2api,deepseek-reasoner"      â”‚ Refers to â”‚
â”‚   },                                            â”‚ provider  â”‚
â”‚   "Providers": [                                â”‚ below     â”‚
â”‚     {                                           â”‚           â”‚
â”‚       "name": "droid2api",  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       "api_base_url": "http://localhost:3000/v1/...",  â†â”€â”  â”‚
â”‚       "api_key": "dummy",                                â”‚  â”‚
â”‚       "models": ["claude-opus-4", "gpt-5-mini", ...]     â”‚  â”‚
â”‚     }                                                    â”‚  â”‚
â”‚   ]                                                      â”‚  â”‚
â”‚ }                                                        â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                                                           â”‚
                                                           â”‚ Points to
                                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
â”‚           /path/to/droid2api/config.json                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                           â”‚
â”‚   "port": 3000,                                             â”‚
â”‚   "models": [                                               â”‚
â”‚     {                                                       â”‚
â”‚       "id": "claude-opus-4",      â†â”€â”€â”€â”                     â”‚
â”‚       "type": "anthropic",            â”‚ Model definitions   â”‚
â”‚       "reasoning": "high"             â”‚                     â”‚
â”‚     },                                â”‚                     â”‚
â”‚     {                                 â”‚                     â”‚
â”‚       "id": "gpt-5-mini",         â†â”€â”€â”€â”˜                     â”‚
â”‚       "type": "openai",                                     â”‚
â”‚       "reasoning": "low"                                    â”‚
â”‚     }                                                       â”‚
â”‚   ],                                                        â”‚
â”‚   "endpoints": [                                            â”‚
â”‚     {                                                       â”‚
â”‚       "type": "anthropic",                                  â”‚
â”‚       "base_url": "https://api.anthropic.com/v1/messages"  â”‚
â”‚     },                                                      â”‚
â”‚     {                                                       â”‚
â”‚       "type": "openai",                                     â”‚
â”‚       "base_url": "https://api.openai.com/v1/..."          â”‚
â”‚     }                                                       â”‚
â”‚   ]                                                         â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Cost Savings Visualization

```
Traditional Setup (Direct API calls)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Daily Usage:
â€¢ 50 interactive coding tasks      â†’ Claude Opus 4    â†’ $7.50
â€¢ 200 background checks            â†’ Claude Opus 4    â†’ $30.00
â€¢ 30 deep reasoning tasks          â†’ Claude Opus 4    â†’ $4.50
â€¢ 20 long context reads            â†’ Claude Opus 4    â†’ $3.00
                                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                      Daily Total: $45.00
                                      Monthly: $1,350


Optimized Setup (Smart Routing via ccr + droid2api)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Daily Usage:
â€¢ 50 interactive coding tasks      â†’ Claude Opus 4    â†’ $7.50
â€¢ 200 background checks            â†’ GPT-5-mini       â†’ $1.20
â€¢ 30 deep reasoning tasks          â†’ DeepSeek-R1     â†’ $0.50
â€¢ 20 long context reads            â†’ Gemini 2.5 Pro  â†’ $0.00
                                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                      Daily Total: $9.20
                                      Monthly: $276

ğŸ’° Savings: $1,074/month (79.6% reduction!)


Visual Cost Comparison:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Traditional:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ $1,350
              â”‚
              â”‚
Optimized:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ $276
              â”‚
              â””â”€ 79.6% savings

Cost per task type:

Interactive:  â–ˆâ–ˆâ–ˆâ–ˆ $7.50 â”€â”€â”¬â”€â”€ Same quality
              â–ˆâ–ˆâ–ˆâ–ˆ $7.50 â”€â”€â”˜   (no sacrifice)

Background:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ $30.00 â”€â”€â”¬
              â–ˆ $1.20 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€ 96% savings!

Reasoning:    â–ˆâ–ˆâ–ˆ $4.50 â”€â”€â”¬
              â–ˆ $0.50 â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 89% savings!

Long Context: â–ˆâ–ˆ $3.00 â”€â”€â”¬
              FREE â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 100% savings!
```

## Monitoring Dashboard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  claude-code-router Dashboard                    â”‚
â”‚                    http://localhost:3456/ui                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Total Requests â”‚  â”‚   Token Usage   â”‚  â”‚  Cost Today     â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚      1,247      â”‚  â”‚   2.4M tokens   â”‚  â”‚     $9.20       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Requests by Model (Last 24h)                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  claude-opus-4:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50 (interactive)           â”‚   â”‚
â”‚  â”‚  gpt-5-mini:        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 200 (bg)       â”‚   â”‚
â”‚  â”‚  deepseek-reasoner: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30 (thinking)                â”‚   â”‚
â”‚  â”‚  gemini-2.5-pro:    â–ˆâ–ˆâ–ˆâ–ˆ 20 (long context)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Routing Decisions                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  17:42:15  tokens=5234    â†’ think        â†’ deepseek-r1  â”‚   â”‚
â”‚  â”‚  17:41:03  tokens=145678  â†’ longContext  â†’ gemini-pro   â”‚   â”‚
â”‚  â”‚  17:40:21  tokens=892     â†’ background   â†’ gpt-5-mini   â”‚   â”‚
â”‚  â”‚  17:39:45  tokens=3421    â†’ default      â†’ claude-opus  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Active Sessions & Token Usage               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Session abc123: 45,234 tokens  (claude-opus-4)         â”‚   â”‚
â”‚  â”‚  Session def456: 123,567 tokens (gemini-2.5-pro)        â”‚   â”‚
â”‚  â”‚  Session ghi789: 8,901 tokens   (gpt-5-mini)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling & Failover

```
Request Flow with Error Handling
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Request arrives at claude-code-router
   â”‚
   â”œâ”€ Try primary model: "droid2api,claude-opus-4"
   â”‚  â”‚
   â”‚  â””â”€ Forward to droid2api â”€â”€â”
   â”‚                             â”‚
2. droid2api receives request   â”‚
   â”‚                             â”‚
   â”œâ”€ Check auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚  â”œâ”€ Try FACTORY_API_KEY
   â”‚  â”œâ”€ Try refresh_token (auto-refresh if expired)
   â”‚  â”œâ”€ Try ~/.factory/auth.json
   â”‚  â””â”€ Fallback to client auth
   â”‚
   â”œâ”€ Transform request format
   â”‚
   â”œâ”€ Call Anthropic API â”€â”€â”€â”€â”€â”€â”
   â”‚                            â”‚
   â””â”€ Handle errors:            â”‚
      â”‚                         â”‚
      â”œâ”€ 429 Rate Limit â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ Retry with backoff
      â”‚                         â”‚
      â”œâ”€ 401 Auth Error â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â†’ Refresh token
      â”‚                         â”‚   Try again
      â”‚                         â”‚
      â”œâ”€ 503 Service Unavail â”€â”€â”€â”¼â”€â†’ Return error to
      â”‚                         â”‚   claude-code-router
      â”‚                         â”‚
      â””â”€ Timeout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. claude-code-router handles failover
   â”‚
   â”œâ”€ Primary failed (Anthropic)
   â”‚
   â”œâ”€ Try fallback: "droid2api,gpt-5"
   â”‚  â”‚
   â”‚  â””â”€ Forward to droid2api again
   â”‚     â”‚
   â”‚     â””â”€ Now routes to OpenAI endpoint
   â”‚        â”‚
   â”‚        â””â”€ Success! â”€â”€â†’ Return response
   â”‚
   â””â”€ If fallback also fails:
      â””â”€ Try emergency: "droid2api,deepseek-v3"
         â””â”€ Log failure, return to user

Failover Priority Chain:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Priority 1: claude-opus-4 (Anthropic)  â† Primary
Priority 2: gpt-5 (OpenAI)             â† Fallback
Priority 3: deepseek-v3 (DeepSeek)     â† Emergency
Priority 4: Return error to user       â† Last resort
```

---

**Diagram Legend**:
- `â†’` : Data flow direction
- `â”œâ”€` : Decision branch
- `â–¼` : Process flow
- `â”` : Section separator
- `â–ˆ` : Visual bar chart element
